<html lang="en" xmlns:th="http://www.thymeleaf.org" th:fragment="summary">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" type="text/css" href="/webjars/bootstrap/4.3.1/css/bootstrap.min.css" th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}">

<link rel="stylesheet" type="text/css" href="/webjars/jquery-ui/1.12.1/jquery-ui.min.css" th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}">

<script src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js" th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>

<script src="/webjars/popper.js/1.14.7/umd/popper.min.js" th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>

<script src="/webjars/jquery/3.4.1/jquery.min.js" th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>

<script src="/webjars/jquery-ui/1.12.1/jquery-ui.min.js" th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>

<script src="/webjars/jquery-form/4.2.2/jquery.form.min.js" th:src="@{/webjars/jquery-form/4.2.2/jquery.form.min.js}"></script>

<script src="/webjars/jquery-validation/1.19.0/jquery.validate.min.js" th:src="@{/webjars/jquery-validation/1.19.0/jquery.validate.min.js}"></script>

<script src="js/bootstrap411.js"></script>

<style>
table.dataTable thead th, table.dataTable tfoot th {
	font-weight: normal;
}

table.table .thead-light th {
	font-size: 15px;
	border-color: #d4d7da;
}

table th {
	color: white;
	background-color: #2e455deb;
	font-size: small;
}

table td {
	font-size: small;
}

.dataTables_filter input {
	float: right;
	margin-top: 10px;
	margin-right: 10px;
}

td {
	font-size: small;
	background-color: #f8f7ff;
}

th {
	color: white;
	background-color: #2e455deb;
	font-size: medium;
}

table, tr {
	border-collapse: collapse;
	width: 100%;
}

th, td {
	border: 1px solid #dddddd;
	padding: 12px;
	text-align: left;
}

.menu-title-header {
	padding: 0.45rem 0.45rem;
	background: #377486;
	color: #fff;
	font-family: "Nunito", calibry;
}

.modal-title {
	text-align: center;
	font-size: 14px;
	font-weight: 900;
	color: #332d2d;
	font-family: calibry
}

.container-manager {
	padding-right: 43px;
	padding-left: 15px;
	margin-right: auto;
	margin-left: 18.3%;
	margin-top: 80px;
}

.modal {
	background-color: rgb(0, 0, 0);
	background-color: rgba(0, 0, 0, 0.4);
}

.radio {
	display: none;
}

body {
	background-color: lightgrey;
}

.menu-title-header {
	padding: 0.45rem 0.45rem;
	background: #377486;
	color: #fff;
	font-family: "Nunito", calibry;
}

.modal-title {
	text-align: center;
	font-size: 14px;
	font-weight: 900;
	color: #332d2d;
	font-family: calibry
}

#overlay {
	position: fixed;
	top: 0;
	z-index: 100;
	width: 100%;
	height: 100%;
	display: none;
	background: rgba(0, 0, 0, 0.6);
}

.cv-spinner {
	height: 100%;
	display: flex;
	justify-content: center;
	align-items: center;
}

input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
	-webkit-appearance: none;
	margin: 0;
}

.dataTables_empty {
	color: #be3232;
}

.card:hover {
	box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
}

.modal {
	background-color: rgb(0, 0, 0);
	background-color: rgba(0, 0, 0, 0.4);
}

#usertable td {
	padding: 13px;
}

.dataTables_scrollBody {
	overflow: unset !important;
}

.dataTables_wrapper .dataTables_filter {
	float: right;
	margin-top: 10px;
}

.dataTables_filter input {
	color: black;
	background-color: white;
}

.dataTables_wrapper .dataTables_filter input[type="search"]::placeholder {
	color: black;
	font-style: italic;
}
</style>

<script>

	// Handle Date Select Box
	
	function getChargeBackRecords() {
		var valueDate = $('#currentDate').val();
		var tranType = $('#transactionFilter').val();
		var tranRecord = null;

		if (tranType === "chargeBackRecord") {
			tranRecord = "ALL";
		} else if (tranType === "pendingChargeBackTransaction") {
			tranRecord = "PENDING";
		}else if(tranType === "InitiateTransaction"){
			tranRecord = "INITIATE";
		} else {
			tranRecord = "REVERTED";
		}
		
		if(tranRecord === "INITIATE"){
			$.ajax({
				url: './InitiateSingleDateforChargeback?valueDate=' + valueDate + "&tranRecord=" + tranRecord,
				type: 'GET',
				success: function (data) {
					console.log(data);
					var trHTML = '';
					if (data.length > 0) {
						data.forEach(function (entity) {
							var tranDate = null;
							if (entity.tran_date != null) {
								var originalStartDate = new Date(entity.tran_date);
								var startYear = originalStartDate.getFullYear();
								var startMonth = String(originalStartDate.getMonth() + 1).padStart(2, '0');
								var startDay = String(originalStartDate.getDate()).padStart(2, '0');
								//tranDate = `${startDay}-${startMonth}-${startYear}`;
								tranDate = entity.tran_date ;
							} else {
								tranDate = "";
							}
							var reversalDate = null;
							if (entity.reversal_date != null) {
								var originalStartDate = new Date(entity.reversal_date);
								var startYear = originalStartDate.getFullYear();
								var startMonth = String(originalStartDate.getMonth() + 1).padStart(2, '0');
								var startDay = String(originalStartDate.getDate()).padStart(2, '0');
								reversalDate = entity.reversal_date ;
							} else {
								reversalDate = "";
							} 
							var billAmount = null;
							if (entity.bill_amount != null) {
								let stringValue1 = entity.bill_amount;
								let floatValue1 = parseFloat(stringValue1);
								let roundedValue1 = floatValue1.toFixed(2);
								billAmount = formatNumberWithCommas(roundedValue1);
							} else {
								billAmount = "0.00";
							}
							var reversalAmount = null;
							if (entity.reversal_amount != null) {
								let stringValue1 = entity.reversal_amount;
								let floatValue1 = parseFloat(stringValue1);
								let roundedValue1 = floatValue1.toFixed(2);
								reversalAmount = formatNumberWithCommas(roundedValue1);
							} else {
								reversalAmount = "0.00";
							}
 							var merchantId = entity.merchant_id != null ? entity.merchant_id : "";
							var sequenceUniqueId = entity.sequence_unique_id != null ? entity.sequence_unique_id : "";
							var tranAuditNumber = entity.tran_audit_number != null ? entity.tran_audit_number : "";
							var merchantBillNumber = entity.merchant_bill_number != null ? entity.merchant_bill_number : "";
							var ipsxAcct = entity.ipsx_account ? entity.ipsx_account.slice(0, 4) + 'XXXXXXX' + entity.ipsx_account.slice(-3) : "";
							var ipsxAcctName = entity.ipsx_account_name != null ? entity.ipsx_account_name : "";
							var cimAcct = entity.cim_account != null ? entity.cim_account.slice(0, 4) + 'XXXXXXX' + entity.cim_account.slice(-3) : "";
							var cimAcctName = entity.cim_account_name != null ? entity.cim_account_name : "";
							var tranCurrency = entity.tran_currency != null ? entity.tran_currency : "";
							var reversalRemarks = entity.reversal_remarks != null ? entity.reversal_remarks : "";

							trHTML += '<tr>' +
								'<td style="text-align: left;">' + tranDate  + '</td>' +
								'<td style="text-align: left;">' + reversalDate  + '</td>' +
								'<td style="text-align: left;">' + tranAuditNumber + '</td>' +
								'<td style="text-align: left;">' + merchantBillNumber + '</td>' +
								//'<td style="text-align: left;">' + merchantId + '</td>' +
								'<td style="text-align: left;">' + cimAcct + '</td>' +
								/* '<td style="text-align: left;">' + cimAcctName + '</td>' + */
								'<td style="text-align: left;">' + ipsxAcct + '</td>' +
								'<td style="text-align: left;">' + ipsxAcctName + '</td>' +
								'<td style="text-align: left;">' + tranCurrency + '</td>' +
								'<td style="text-align: right;">' + billAmount + '</td>' +
								'<td style="text-align: right;">' + reversalAmount + '</td>' +
								'<td style="text-align: left;">' + reversalRemarks + '</td>' +
								'<td style="text-align: center;">' +
								'<input type="radio" id="btnclick" name="btnradio"' +
								' style="cursor: pointer;"' +
								' data-sequence_unique_id="' + sequenceUniqueId + '"' +
								' id="' + sequenceUniqueId + '"' +
								' onclick="listcharge1(this); openForm();">' +
								'</td>' +
								'</tr>';
						});

						var userTable = $('#usertable').DataTable({
							"destroy": true,
							"scrollCollapse": true,
							"paging": true,
							"autoWidth": false,
							"ordering": true,
							"oLanguage": {
								"sSearch": "",
								"sSearchPlaceholder": "Search Here"
							},
							"searching": true,
							"pageLength": 10,
							"lengthChange": false,
						});
						userTable.clear().draw();
						$('#chargeBackBody').empty().append(trHTML);
						userTable.rows.add($('#chargeBackBody tr')).draw();
					} else {
						trHTML += '<tr><td colspan="10" class="text-center" style="color:red;">No data available</td></tr>';
						$('#chargeBackBody').empty().append(trHTML);
						var userTable = $('#usertable').DataTable({
							"destroy": true,
							"scrollCollapse": true,
							"paging": true,
							"autoWidth": false,
							"ordering": true,
							"oLanguage": {
								"sSearch": "",
								"sSearchPlaceholder": "Search Here"
							},
							"searching": true,
							"pageLength": 10,
							"lengthChange": false,
						});
						userTable.clear().draw();
					}
				},
				error: function () {
					showErrorModal('Error fetching data');
				}
			});
		}else{
			$.ajax({
				url: './getChargeBackRecords?valueDate=' + valueDate + "&tranRecord=" + tranRecord,
				type: 'GET',
				success: function (data) {
					console.log(data);
					var trHTML = '';
					if (data.length > 0) {
						data.forEach(function (entity) {
							var tranDate = null;
							if (entity.tran_date != null) {
								var originalStartDate = new Date(entity.tran_date);
								var startYear = originalStartDate.getFullYear();
								var startMonth = String(originalStartDate.getMonth() + 1).padStart(2, '0');
								var startDay = String(originalStartDate.getDate()).padStart(2, '0');
								tranDate = entity.tran_date ;
							} else {
								tranDate = "";
							}
							var reversalDate = null;
							if (entity.reversal_date != null) {
								var originalStartDate = new Date(entity.reversal_date);
								var startYear = originalStartDate.getFullYear();
								var startMonth = String(originalStartDate.getMonth() + 1).padStart(2, '0');
								var startDay = String(originalStartDate.getDate()).padStart(2, '0');
								reversalDate = entity.reversal_date ;
							} else {
								reversalDate = "";
							} 

							var billAmount = null;

							if (entity.bill_amount != null) {
								let stringValue1 = entity.bill_amount;
								let floatValue1 = parseFloat(stringValue1);
								let roundedValue1 = floatValue1.toFixed(2);
								billAmount = formatNumberWithCommas(roundedValue1);
							} else {
								billAmount = "0.00";
							}

							var reversalAmount = null;

							if (entity.reversal_amount != null) {
								let stringValue1 = entity.reversal_amount;
								let floatValue1 = parseFloat(stringValue1);
								let roundedValue1 = floatValue1.toFixed(2);
								reversalAmount = formatNumberWithCommas(roundedValue1);
							} else {
								reversalAmount = "0.00";
							}
							
 							var merchantId = entity.merchant_id != null ? entity.merchant_id : "";
							var sequenceUniqueId = entity.sequence_unique_id != null ? entity.sequence_unique_id : "";
							var tranAuditNumber = entity.tran_audit_number != null ? entity.tran_audit_number : "";
							var merchantBillNumber = entity.merchant_bill_number != null ? entity.merchant_bill_number : "";
							var ipsxAcct = entity.ipsx_account != null ? entity.ipsx_account.slice(0, 4) + 'XXXXXXX' + entity.ipsx_account.slice(-3) : "";
							var ipsxAcctName = entity.ipsx_account_name != null ? entity.ipsx_account_name : "";
							var cimAcct = entity.cim_account != null ? entity.cim_account.slice(0, 4) + 'XXXXXXX' + entity.cim_account.slice(-3): "";
							var cimAcctName = entity.cim_account_name != null ? entity.cim_account_name : "";
							var tranCurrency = entity.tran_currency != null ? entity.tran_currency : "";
							var reversalRemarks = entity.reversal_remarks != null ? entity.reversal_remarks : "";

							trHTML += '<tr>' +
								'<td style="text-align: left;">' + tranDate  + '</td>' +
								'<td style="text-align: left;">' + reversalDate  + '</td>' +
								'<td style="text-align: left;">' + tranAuditNumber + '</td>' +
								'<td style="text-align: left;">' + merchantBillNumber + '</td>' +
								//'<td style="text-align: left;">' + merchantId + '</td>' +
								'<td style="text-align: left;">' + cimAcct + '</td>' +
								//'<td style="text-align: left;">' + cimAcctName + '</td>' +
								'<td style="text-align: left;">' + ipsxAcct + '</td>' +
								'<td style="text-align: left;">' + ipsxAcctName + '</td>' +
								'<td style="text-align: left;">' + tranCurrency + '</td>' +
								'<td style="text-align: right;">' + billAmount + '</td>' +
								'<td style="text-align: right;">' + reversalAmount + '</td>' +
								'<td style="text-align: left;">' + reversalRemarks + '</td>' +
								'<td style="text-align: center;">' +
								'<input type="radio" id="btnclick" name="btnradio"' +
								' style="cursor: pointer;"' +
								' data-sequence_unique_id="' + sequenceUniqueId + '"' +
								' id="' + sequenceUniqueId + '"' +
								' onclick="listcharge(this); openForm();">' +
								'</td>' +
								// Add more columns for end date and interest amount if needed
								'</tr>';
						});

						var userTable = $('#usertable').DataTable({
							"destroy": true,
							"scrollCollapse": true,
							"paging": true,
							"autoWidth": false,
							"ordering": true,
							"oLanguage": {
								"sSearch": "",
								"sSearchPlaceholder": "Search Here"
							},
							"searching": true,
							"pageLength": 10,
							"lengthChange": false,
						});
						userTable.clear().draw();
						$('#chargeBackBody').empty().append(trHTML);
						userTable.rows.add($('#chargeBackBody tr')).draw();
					} else {
						trHTML += '<tr><td colspan="10" class="text-center" style="color:red;">No data available</td></tr>';
						$('#chargeBackBody').empty().append(trHTML);
						var userTable = $('#usertable').DataTable({
							"destroy": true,
							"scrollCollapse": true,
							"paging": true,
							"autoWidth": false,
							"ordering": true,
							"oLanguage": {
								"sSearch": "",
								"sSearchPlaceholder": "Search Here"
							},
							"searching": true,
							"pageLength": 10,
							"lengthChange": false,
						});
						userTable.clear().draw();
					}
				},
				error: function () {
					showErrorModal('Error fetching data');
				}
			});
		}
	}

	$(function () {
		$("#from_date").datepicker({
			dateFormat: 'dd/mm/yy',
			maxDate: new Date(),
			onClose: function (selectedDate) {
				$("#to_date").datepicker("option", "minDate", selectedDate);
			}
		});
		$("#to_date").datepicker({
			dateFormat: 'dd/mm/yy',
			maxDate: new Date(),
			onClose: function (selectedDate) {
				$("#from_date").datepicker("option", "maxDate", selectedDate);
			}
		});
	});

		function formatDate1(dateString) {
			var dateParts = dateString.split("/");
			var day = dateParts[0];
			var month = parseInt(dateParts[1], 10); // Convert month to integer
			var year = dateParts[2];
			var monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL",
				"AUG", "SEP", "OCT", "NOV", "DEC"];
			var monthName = monthNames[month - 1];
			return day + "-" + monthName + "-" + year;
		}

		function home() {
			location.href = './IPSDashboard'
		}

		function back() {
			window.history.back();
		}

		$(function () {
			$("#tran_date, #bill_date").datepicker({
				dateFormat: "dd-mm-yy"
			});
		});

		$(function () {
			$("#reversal_date").datepicker({
				dateFormat: "dd-mm-yy",
				minDate: 0
			});
		});

		var currentDate = new Date();
		$("#reversal_date").datepicker("setDate", currentDate);

		function listcharge(a) {
			var message_ref = a.getAttribute("data-sequence_unique_id");
			location.href = 'chargeBackRecord?formmode=addCharge&sql_unic_id='
				+ message_ref;
		}
		function listcharge1(a) {
			var message_ref = a.getAttribute("data-sequence_unique_id");
			location.href = 'chargeBackRecord?formmode=CustTxn&sql_unic_id='
				+ message_ref;
		}
		
		function listchargesingleDate(a) {
			var message_ref = a.getAttribute("data-sequence_unique_id");
			location.href = 'chargeBackRecord?formmode=CustTxn&sql_unic_id='
				+ message_ref;
		}

		$(document).ready(function () {
			$('#usertable').DataTable({
				"destroy": true,
				"scrollCollapse": true,
				"paging": true,
				"autoWidth": false,
				"ordering": true,
				"oLanguage": {
					"sSearch": "",
					"sSearchPlaceholder": "Search Here"
				},
				"searching": true,
				"pageLength": 10,
				"lengthChange": false,
			});
		});

		$(document).ready(function () {

			$("#currentDate").datepicker({
				dateFormat: 'dd-mm-yy',
				maxDate: new Date()

			});
		});
		
		function handleInitiate() {
			 var userid = document.getElementById('user_id').value; 
			 var seqUniqueID = document.getElementById('sequence_unique_id').value; 
			 var merchant_id = document.getElementById('merchant_id').value; 
			$.ajax({
				url : './ChargeInitiate',
				data : {
					userid : userid,
					seqUniqueID : seqUniqueID,
					merchant_id : merchant_id
				},
				type : 'POST', 
				success: function (response) { 
					$('#myModalpopup2').modal("toggle");
	                $('#myModalpopup2 .modal-body').text(data);
				},error: function (xhr, status, error) {
					var response;
					var contentType = xhr.getResponseHeader("content-type") || "";
					if (contentType.indexOf("application/json") !== -1) {
						response = JSON.parse(xhr.responseText);
					} else {
						response = { status: 'unknown', error: xhr.responseText };
					}
					var errorMessage = 'Error: ' + response.error + ' (Status: ' + status + ')';
					$('#myModalpopup1').modal("toggle");
	                $('#myModalpopup1 .modal-body').text('Status: ' + response.status + ' Error: ' + response.error);
					console.error(xhr, status, error);
				}
			});
		}

		function handleIn(input) {
			input.value = input.value.replace(/[^\w\s]/gi, '').toUpperCase();
			updateMerchantId(input.value);
		}

		function formatNumberWithCommas(number) {

			if (!number && number !== 0) return '';

			let numberString = number.toString();


			let [integerPart, decimalPart] = numberString.split('.');

			let lastThreeDigits = integerPart.slice(-3);
			let otherDigits = integerPart.slice(0, -3);

			if (otherDigits !== '') {
				lastThreeDigits = ',' + lastThreeDigits;
			}

			let formattedIntegerPart = otherDigits.replace(/\B(?=(\d{2})+(?!\d))/g, ',') + lastThreeDigits;

			if (!decimalPart) {
				decimalPart = '00';
			}
			let formattedNumber = formattedIntegerPart + '.' + decimalPart;


			return formattedNumber;
		}
	</script>


</head>

<body>
	<div th:insert="MMenupage :: header"></div>
	<div class="container-manager">
		<div id="overlay">
			<div class="cv-spinner">
				<span class="spinner"></span>
			</div>
		</div>

		<div th:if="${formmode}=='list' OR ${formmode}==null  OR ${formmode}=='Initiate' OR ${formmode}=='Revert' OR ${formmode}=='Pending'" class="content pt-2">
			<div class="card">
				<div class="card-header">
					<div class="d-flex justify-content-between align-items-center">
						<h4 style="color: white; font-size: 1.5rem;">Charge Back Transactions List</h4>
						<div>
							<label style="font-size: 20px !important">Search Records by Date :</label> <input type="text" class="pl-2" style="height: 30px !important" id="currentDate" onchange="getChargeBackRecords();"
								th:value="${currentDate != null ? #dates.format(currentDate, 'dd-MM-yyyy') : ''}" readonly>
						</div>
					</div>
				</div>
				<div class="card-body p-0">
					<div class="float-right">
						<div class="btn-group nav-buttons">
							<select class="form-control-sm" id="transactionFilter" onchange="getChargeBackRecords()" style="background-color: #e3e3e4; padding: 0px 10px 0px 28px; font-size: 21px; margin: 14px 15px 0px 0px;">
								<option value="" hidden="true">Select</option>
								<option th:selected="${formmode}=='Initiate'" value="InitiateTransaction">Initiate Transactions</option>
								<option th:selected="${formmode}=='Revert'" value="RevertedChargeBackTransaction">Reverted Transactions</option>
								<option th:selected="${formmode}=='Pending'" value="pendingChargeBackTransaction">Pending Transactions</option>
								<option th:selected="${formmode}=='list'" value="chargeBackRecord">All Transactions</option>
							</select>
						</div>
					</div>
					<table class="table table-striped table-bordered  table-hover table-sm" id="usertable">
						<thead>
							<tr>
								<th>Tran Date</th>
								<th>Rev Date</th>
								<th>Audit Ref</th>
								<th>Bill Num</th>
								<!-- <th>Mer Id</th> -->
								<th>Mer Acct</th>
								<!-- <th>Mer Acct Name</th> -->
								<th>Cus Acct</th>
								<th>Cus Acct Name</th>
								<th>Currency</th>
								<th>Bill Amount</th>
								<th>Rev Amount</th>
								<th>Remarks</th>
								<th>Select</th>
							</tr>
						</thead>
						<tbody id="chargeBackBody">
							<tr th:each="charge:${Back}">
								<td style="width: 200px" th:text="${charge.sequence_unique_id != null ? charge.sequence_unique_id.toUpperCase() : ''}"></td>
								<td style="width: 200px" th:text="${charge.tran_date != null ? #dates.format(charge.tran_date, 'dd-MM-yyyy') : ''}"></td>
								<td style="width: 200px" th:text="${charge.reversal_date != null ? #dates.format(charge.reversal_date, 'dd-MM-yyyy') : ''}"></td>
								<td style="width: 125px" th:text="${charge.merchant_bill_number != null ? charge.merchant_bill_number.toUpperCase() : ''}"></td>
								<!-- <td style="width: 150px"
									th:text="${charge.merchant_id != null ? charge.merchant_id.toUpperCase() : ''}">
								</td> -->
								<td style="width: 150px" th:text="${charge.cim_account != null ? charge.cim_account.substring(0, 4) + 'XXXXXXX' + charge.cim_account.substring(charge.cim_account.length() - 3) : ''}"></td>
								<!-- <td style="width: 150px"
									th:text="${charge.cim_account_name != null ? charge.cim_account_name.toUpperCase() : ''}">
								</td> -->
								<td style="width: 150px" th:text="${charge.ipsx_account != null ? charge.ipsx_account.substring(0, 4) + 'XXXXXXX' + charge.ipsx_account.substring(charge.ipsx_account.length() - 3) : ''}"></td>
								<td style="width: 150px" th:text="${charge.ipsx_account_name != null ? charge.ipsx_account_name.toUpperCase() : ''}"></td>
								<td style="width: 125px" th:text="${charge.tran_currency != null ? charge.tran_currency.toUpperCase() : ''}"></td>
								<td style="text-align: right;" th:text="${charge.bill_amount != null ? #numbers.formatDecimal(charge.bill_amount, 0, 'COMMA', 2, 'POINT') : ' '}"></td>
								<td style="text-align: right; width: 150px" th:text="${charge.reversal_amount != null ? #numbers.formatDecimal(charge.reversal_amount, 0, 'COMMA', 2, 'POINT') : ' '}"></td>
								<td style="width: 125px" th:text="${charge.reversal_remarks != null ? charge.reversal_remarks.toUpperCase() : ''}"></td>
								<td th:if="${formmode}!='Initiate'" style="text-align: center;"><input type="radio" id="btnclick" name="btnradio" style="cursor: pointer;" th:attr="data-sequence_unique_id=${charge.sequence_unique_id}"
									th:id="${charge.sequence_unique_id}" onclick="listcharge(this); openForm();"></td>
								<td th:if="${formmode}=='Initiate'" style="text-align: center;"><input type="radio" id="btnclick" name="btnradio" style="cursor: pointer;" th:attr="data-sequence_unique_id=${charge.sequence_unique_id}"
									th:id="${charge.sequence_unique_id}" onclick="listcharge1(this); openForm();"></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="card-footer text-center">
					<button type="button" class="btn btn-sm commonBtnStyle mr-2" data-dismiss="modal" onclick="home();">Home</button>
					<button type="button" class="btn btn-sm commonBtnStyle" data-dismiss="modal" onclick="back();">Back</button>
				</div>
			</div>
		</div>

		<!-- <div th:if="${formmode}==''" class="content">
			<div class="card">
				<div class="card-header">
					<div class="float-left">
						<h4 style="color: white; font-size: 1.2rem;"
							th:if="${formmode}=='list'">Charge Back Transactions List</h4>
						<h4 style="color: white; font-size: 1.2rem;"
							th:if="${formmode}=='Revert'">Reverted Charge Back
							Transactions List</h4>
						<h4 style="color: white; font-size: 1.2rem;"
							th:if="${formmode}=='Pending'">Pending Charge Back
							Transactions List</h4>
						<h4 style="color: white; font-size: 1.2rem;"
							th:if="${formmode}=='Initiate'">Initiate Charge Back
							Transactions List</h4>
					</div>
				</div>
				<div class="card-body p-0">
					<div class="row formline mt-2">
						<div class="col-sm-2">
							<label>Search Records by Date :</label>
						</div>
						<div class="col-sm-2">
							<input type="text" id="currentDate"
								onchange="getChargeBackRecords();"
								th:value="${currentDate != null ? #dates.format(currentDate, 'dd-MM-yyyy') : ''}"
								readonly>
						</div>
						<div class="d-flex ml-auto">
							<div class="btn-group nav-buttons mr-4">
								<h4 style="color: white; font-size: 1.2rem;">
									<select class="form-control-sm" id="transactionFilter"
										onchange="getChargeBackRecords()"
										style="background-color: #e3e3e4;">
										<option value="" hidden="true">Select</option>
										<option th:selected="${formmode}=='list'"
											value="chargeBackRecord">All Transactions</option>
										<option th:selected="${formmode}=='Revert'"
											value="RevertedChargeBackTransaction">Reverted
											Transactions</option>
										<option th:selected="${formmode}=='Pending'"
											value="pendingChargeBackTransaction">Pending
											Transactions</option>
										<option th:selected="${formmode}=='Initiate'"
											value="InitiateTransaction">Initiate Transactions</option>
									</select>
								</h4>
							</div>
						</div>
					</div>
					<table
						class="table table-striped table-bordered table-hover table-sm"
						id="usertable">
						<thead>
							<tr>
								<th>Merchant Id</th>
								<th>Tran Date</th>
								<th>Ref ID</th>
								<th>User Id</th>
								<th>Unit Id</th>
								<th>Unit Name</th>
								<th>Bank Name</th>
								<th>Mer Acct Name</th>
								<th>Merchant Account</th>
								<th>Cust Acct Name</th>
								<th>Cust Account</th>
								<th>Currency</th>
								<th>Amount</th>
								<th>Status</th>
								<th>Rev Remarks</th>

							</tr>
						</thead>
						<tbody id="transactionBody">
							<tr th:each="details:${Trans}">
								<td
									th:text="${details?.merchant_id != null ? details.merchant_id.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.tran_date !=null ? #dates.format(details.tran_date,'dd-MM-yyy') :''}"></td>
								<td
									th:text="${details?.master_ref_id != null ? details.master_ref_id.toUpperCase() : ''}"></td>
								<td th:text="${details?.end_end_id != null ? details.end_end_id.toUpperCase() : ''}"></td>
								<td th:text="${details?.tran_audit_number != null ? details.tran_audit_number.toUpperCase() : ''}"></td>
								<td th:text="${details?.msg_type != null ? details.msg_type.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.user_id != null ? details.user_id.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.unit_id != null ? details.unit_id.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.unit_name != null ? details.unit_name.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.initiator_bank != null ? details.initiator_bank.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.cim_account_name != null ? details.cim_account_name.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.cim_account != null ? details.cim_account.substring(0, 4) + 'XXXXXXX' + details.cim_account.substring(details.cim_account.length() - 3) : ''}"></td>
								<td
									th:text="${details?.ipsx_account_name != null ? details.ipsx_account_name.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.ipsx_account != null ? details.ipsx_account.substring(0, 4) + 'XXXXXXX' + details.ipsx_account.substring(details.ipsx_account.length() - 3) : ''}"></td>
								<td
									th:text="${details?.tran_currency != null ? details.tran_currency.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.tran_amount != null ? #numbers.formatDecimal(details?.tran_amount, 0, 'COMMA', 2, 'POINT') : ''}"></td>
								<td
									th:text="${details?.tran_status != null ? details.tran_status.toUpperCase() : ''}"></td>
								<td
									th:text="${details?.reversal_remarks != null ? details.reversal_remarks.toUpperCase() : ''}"></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="card-footer text-center">
					<button type="button" class="btn btn-sm btn-primary"
						data-dismiss="modal" onclick="home();">Home</button>
					<button type="button" class="btn btn-sm btn-primary"
						data-dismiss="modal" onclick="back();">Back</button>
				</div>
			</div>
		</div> -->

		<div class="content pt-2" th:if="${formmode}=='addCharge' OR ${formmode}=='CustTxn'">
			<div class="card">
				<div class=" card-header">
					<div class="float-left">
						<h4 style="color: white; font-size: 1.5rem; font-weight: bold;">Charge Backs</h4>
					</div>
				</div>
				<div class="card-body pb-0">
					<form action="#" method="POST" autocomplete="off" id="ChargeForm" th:object="${viewcharge}">

						<div class="row formline">
							<div class="col-sm-2" style="text-align: left;">
								<label for="tran_date" style="font-size: 14px;">Transaction Date<span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" name="tran_date" class="form-control form-control-sm" th:value="${#dates.format(viewcharge?.tran_date, 'dd-MM-yyyy')}" readonly>
							</div>
							<div class="col-sm-1"></div>
							<div class="col-sm-2" style="text-align: left;">
								<label for="message_id" style="font-size: 14px;">Message Id <span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="sequence_unique_id" name="sequence_unique_id" class="form-control form-control-sm" onkeyup="this.value = this.value.toUpperCase();handleIn(this)"
									th:value="${viewcharge?.sequence_unique_id}" readonly>
							</div>
						</div>
						<label></label>
						<div class="row formline">
							<div class="col-sm-2" style="text-align: left;">
								<label for="audit_ref" style="font-size: 14px;">Audit Reference <span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="tran_audit_number" name="tran_audit_number" onkeyup="this.value = this.value.toUpperCase();handleIn(this)" class="form-control form-control-sm" th:value="${viewcharge?.tran_audit_number}"
									readonly>
							</div>
							<div class="col-sm-1"></div>
							<div class="col-sm-2" style="text-align: left;">
								<label for="merchant_bill_number" style="font-size: 14px;"> Bill Number<span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="merchant_bill_number" name="merchant_bill_number" class="form-control form-control-sm" th:value="${viewcharge?.merchant_bill_number}" readonly>
							</div>
						</div>
						<label></label>
						<div class="row formline">
							<div class="col-sm-2" style="text-align: left;">
								<label for="bill_date" style="font-size: 14px;">Bill Date <span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="" name="bill_date" class="form-control form-control-sm" th:value="${#dates.format(viewcharge?.bill_date, 'dd-MM-yyyy')}" readonly>
							</div>
							<div class="col-sm-1"></div>
							<div class="col-sm-2" style="text-align: left;">
								<label for="bill_amount" style="font-size: 14px;">Bill Amount <span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="bill_amount" name="bill_amount" class="form-control form-control-sm" th:value="${viewcharge?.bill_amount}" readonly>
							</div>
						</div>
						<label></label>
						<div class="row formline">
							<div class="col-sm-2" style="text-align: left;">
								<label for="tran_currency" style="font-size: 14px;">Currency <span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="tran_currency" name="tran_currency" class="form-control form-control-sm" th:value="${viewcharge?.tran_currency}" readonly>
							</div>
							<div class="col-sm-1"></div>
							<div class="col-sm-2" style="text-align: left;">
								<label for="reversal_remarks" style="font-size: 14px;">Remarks<span style="color: red; font-size: 20px;"> </span></label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="reversal_remarks" name="reversal_remarks" class="form-control form-control-sm" th:value="${viewcharge?.reversal_remarks}" readonly>
							</div>
						</div>
						<label></label>
						<div class="row formline">
							<div class="col-sm-2" style="text-align: left;">
								<label for="currency" style="font-size: 14px;">Reversal Date <span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="reversal_date" name="reversal_date" class="form-control form-control-sm" th:value="${#dates.format(viewcharge?.reversal_date, 'dd-MM-yyyy')}" readonly>
							</div>
							<div class="col-sm-1"></div>
							<div class="col-sm-2" style="text-align: left;">
								<label for="remarks" style="font-size: 14px;">Reversal Amount<span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="reversal_amount" name="reversal_amount" class="form-control form-control-sm" th:value="${viewcharge?.reversal_amount}" readonly>
							</div>
						</div>
						<label></label>
						<div class="row formline" hidden="true">
							<div class="col-sm-2" style="text-align: left;">
								<label for="audit_ref" style="font-size: 14px;"> User Id <span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="user_id" name="user_id" onkeyup="this.value = this.value.toUpperCase();handleIn(this)" class="form-control form-control-sm" th:value="${viewcharge?.user_id}" readonly>
							</div>
							<div class="col-sm-1"></div>
							<div class="col-sm-2" style="text-align: left;">
								<label for="merchant_bill_number" style="font-size: 14px;"> Merchant Id<span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="merchant_id" name="merchant_id" class="form-control form-control-sm" th:value="${viewcharge?.merchant_id}" readonly>
							</div>
						</div>
						<label></label>
						<div class="row formline" hidden="true">
							<div class="col-sm-2" style="text-align: left;">
								<label for="bill_date" style="font-size: 14px;">SequenceId <span style="color: red; font-size: 20px;"> </span>
								</label>
							</div>
							<div class="col-sm-3">
								<input type="text" id="sequence_unique_id" name="sequence_unique_id" class="form-control form-control-sm" th:value="${viewcharge?.sequence_unique_id}" readonly>
							</div>
						</div>
					</form>
				</div>
				<div class="card-footer text-center">
					<button type="button" class="btn btn-sm commonBtnStyle mr-2" data-dismiss="modal" onclick="home();">Home</button>
					<button type="button" class="btn btn-sm commonBtnStyle mr-2"
						th:if="${viewcharge?.reversal_remarks != 'REVERTED' and formmode != 'CustTxn' and LoginUserId != InitiateEntryUser and viewcharge?.chargeback_approval == 'MERCHANT'}" data-dismiss="modal" onclick="handleRevert()">Revert</button>
					<button type="button" class="btn btn-sm commonBtnStyle mr-2" th:if="${viewcharge?.reversal_remarks} != 'REVERTED' and ${viewcharge?.reversal_remarks} != 'INITIATED' and ${formmode}=='CustTxn'" data-dismiss="modal"
						onclick="handleInitiate()">Initiate</button>
					<button type="button" class="btn btn-sm commonBtnStyle" data-dismiss="modal" onclick="back();">Back</button>
				</div>
			</div>
		</div>

		<!-------------- model pop up -------------------->

		<div class="modal fade" id="myModalpopup2" data-backdrop="static" data-keyboard="false" style="background: #000000b0;">
			<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
				<div class="modal-content">
					<h3 class="text-center p-2 text-white font-weight-bold" style="background: #f26223;">BANK OF BARODA</h3>
					<h4 class="modal-body text-center font-weight-bold" style="color: black !important; font-size: 19px"></h4>
					<div class="text-center">
						<button type="button" class="btn mb-2" style="width: 16%; background: #f26223; font-size: 17px;" data-dismiss="modal" onclick="back()">Close</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="myModalpopup1" data-backdrop="static" data-keyboard="false" style="background: #000000b0;">
			<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
				<div class="modal-content">
					<h3 class="text-center p-2 text-white font-weight-bold" style="background: #f26223;">BANK OF BARODA</h3>
					<h4 class="modal-body text-center font-weight-bold" style="color: black !important; font-size: 19px"></h4>
					<div class="text-center">
						<button type="button" class="btn mb-2" style="width: 16%; background: #f26223; font-size: 17px;" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		function handleRevert() {
			console.log("Inside");
			var reversalDateInput = document.getElementById("reversal_date");
			var reversalAmountInput = document.getElementById("reversal_amount");
			var billAmountInput = document.getElementById("bill_amount");
			var reversalRemarksInput = document.getElementById("reversal_remarks");
			if (reversalDateInput.value.trim() === "") {
				reversalDateInput.value = formatDate(new Date());
			}
			if (reversalAmountInput.value.trim() === "") {
				reversalAmountInput.value = billAmountInput.value.trim();
			}
			reversalRemarksInput.value = "REVERTED";
			SubmitCharge();
		}
		
		function formatDate(date) {
			var day = date.getDate();
			var month = date.getMonth() + 1;
			var year = date.getFullYear();
			if (day < 10) {
				day = '0' + day;
			}
			if (month < 10) {
				month = '0' + month;
			}
			return day + '-' + month + '-' + year;
		}

		function SubmitCharge() {
			var message_id = document.getElementById('sequence_unique_id').value;
			$.ajax({
				url: './ChargeBacks',
				data: {
					message_id: message_id
				},
				type: 'POST',
				success: function (data) {
					$('#myModalpopup2').modal("toggle");
	                $('#myModalpopup2 .modal-body').text(data);
				},error: function (xhr, status, error) {
					var response;
					var contentType = xhr.getResponseHeader("content-type") || "";
					if (contentType.indexOf("application/json") !== -1) {
						response = JSON.parse(xhr.responseText);
					} else {
						response = { status: 'unknown', error: xhr.responseText };
					}
					var errorMessage = 'Error: ' + response.error + ' (Status: ' + status + ')';
					$('#myModalpopup1').modal("toggle");
	                $('#myModalpopup1 .modal-body').text('Status: ' + response.status + ' Error: ' + response.error);
					console.error(xhr, status, error);
				}
			});
		}
	</script>
</body>

</html>